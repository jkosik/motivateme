---
# MotivateMe K3s Deployment Playbook
# Deploys K3s on Ubuntu 24.04 with security hardening for Hetzner VM
#
# Usage:
#   1. Edit inventory/hosts.yml and set ansible_host to your VM's public IP
#   2. Run: ansible-playbook -i inventory/hosts.yml playbook.yml
#   3. Get kubeconfig: scp root@YOUR_VM_IP:/etc/rancher/k3s/k3s.yaml ~/.kube/config
#      Then edit ~/.kube/config and replace 127.0.0.1 with your VM IP for remote access

- name: Install prereqisites
  hosts: k3s_cluster
  become: yes
  gather_facts: no

  tasks:
    - name: Install Python 3 and dependencies (for Debian/Ubuntu)
      raw: |
        apt update -y && apt install -y python3 python3-apt python3-six
      changed_when: false
      tags: 
        - prereq

    - name: Ensure Python 3 path is known
      set_fact:
        ansible_python_interpreter: /usr/bin/python3
      tags: 
        - prereq

    - name: Gather facts after Python is installed
      setup:


- name: Configure OS and K3S
  hosts: k3s_cluster
  become: yes
  gather_facts: yes
  roles:
    - common
    - k3s

  post_tasks:
    - name: Display K3s access information
      debug:
        msg:
          - "==================================================================="
          - "K3s cluster setup complete!"
          - "==================================================================="
          - "Hostname: {{ target_hostname }}"
          - "K3s API: Accessible only from localhost (127.0.0.1:6443)"
          - "K3s Ingress: Accessible externally on ports 80/443"
          - ""
          - "To access K3s from your local machine:"
          - "  scp root@{{ ansible_host }}:/etc/rancher/k3s/k3s.yaml ~/.kube/config"
          - "  # Edit ~/.kube/config and replace 127.0.0.1 with {{ ansible_host }}"
          - ""
          - "Test ingress: kubectl get svc -n kube-system traefik"
          - "==================================================================="

