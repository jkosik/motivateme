---
# Common system setup tasks

- name: Set hostname
  hostname:
    name: "{{ target_hostname }}"
  when: target_hostname is defined

- name: Update /etc/hosts with new hostname
  lineinfile:
    path: /etc/hosts
    regexp: '^127\.0\.1\.1'
    line: "127.0.1.1 {{ target_hostname }}"
    state: present
  when: target_hostname is defined

- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Install essential packages
  apt:
    name:
      - jq
      - git
      - curl
      - wget
      - iptables-persistent
      - ca-certificates
      - apt-transport-https
      - software-properties-common
    state: present

- name: Disable and stop UFW (if installed)
  systemd:
    name: ufw
    state: stopped
    enabled: no
  ignore_errors: yes

- name: Set default iptables policies
  iptables:
    chain: "{{ item.chain }}"
    policy: "{{ item.policy }}"
  loop:
    - { chain: 'INPUT', policy: 'DROP' }
    - { chain: 'FORWARD', policy: 'DROP' }
    - { chain: 'OUTPUT', policy: 'ACCEPT' }

- name: Allow loopback
  iptables:
    chain: INPUT
    in_interface: lo
    jump: ACCEPT

- name: Allow established connections
  iptables:
    chain: INPUT
    ctstate: ESTABLISHED,RELATED
    jump: ACCEPT

- name: Allow SSH (port 22)
  iptables:
    chain: INPUT
    protocol: tcp
    destination_port: '22'
    jump: ACCEPT
    comment: SSH

- name: Allow HTTP (port 80)
  iptables:
    chain: INPUT
    protocol: tcp
    destination_port: '80'
    jump: ACCEPT
    comment: HTTP

- name: Allow HTTPS (port 443)
  iptables:
    chain: INPUT
    protocol: tcp
    destination_port: '443'
    jump: ACCEPT
    comment: HTTPS

- name: Allow K3s API from pod network
  iptables:
    chain: INPUT
    source: 10.42.0.0/16
    protocol: tcp
    destination_port: '6443'
    jump: ACCEPT
    comment: K3s-pods

- name: Allow K3s API from service network
  iptables:
    chain: INPUT
    source: 10.43.0.0/16
    protocol: tcp
    destination_port: '6443'
    jump: ACCEPT
    comment: K3s-svc

- name: Block K3s API from external (explicit DROP)
  iptables:
    chain: INPUT
    protocol: tcp
    destination_port: '6443'
    jump: DROP
    comment: Block-K3s-API

- name: Block K3s metrics from external
  iptables:
    chain: INPUT
    protocol: tcp
    destination_port: '10250'
    jump: DROP
    comment: Block-metrics

- name: Save iptables rules
  shell: netfilter-persistent save
  changed_when: false

- name: Optionally disable IPv6 (for maximum security)
  sysctl:
    name: "{{ item }}"
    value: '1'
    state: present
    reload: yes
  loop:
    - net.ipv6.conf.all.disable_ipv6
    - net.ipv6.conf.default.disable_ipv6
    - net.ipv6.conf.lo.disable_ipv6
  when: disable_ipv6 | default(false) | bool
  tags:
    - ipv6

- name: Disable swap (required for Kubernetes)
  shell: |
    swapoff -a
    sed -i '/ swap / s/^/#/' /etc/fstab

- name: Load required kernel modules
  modprobe:
    name: "{{ item }}"
    state: present
  loop:
    - overlay
    - br_netfilter

- name: Ensure kernel modules load on boot
  copy:
    dest: /etc/modules-load.d/k3s.conf
    content: |
      overlay
      br_netfilter

- name: Set sysctl parameters for Kubernetes
  sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    reload: yes
  loop:
    - { name: 'net.bridge.bridge-nf-call-iptables', value: '1' }
    - { name: 'net.bridge.bridge-nf-call-ip6tables', value: '1' }
    - { name: 'net.ipv4.ip_forward', value: '1' }

