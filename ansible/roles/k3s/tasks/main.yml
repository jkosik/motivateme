---
# K3s installation and configuration tasks

- name: Check if K3s is already installed
  stat:
    path: /usr/local/bin/k3s
  register: k3s_installed

- name: Download K3s installation script
  get_url:
    url: https://get.k3s.io
    dest: /tmp/k3s-install.sh
    mode: '0755'
  when: not k3s_installed.stat.exists

- name: Install K3s with secure configuration
  shell: |
    INSTALL_K3S_VERSION="{{ k3s_version | default('v1.28.5+k3s1') }}" \
    INSTALL_K3S_EXEC="server \
      --tls-san={{ ansible_host }} \
      --bind-address={{ k3s_api_bind_address | default('127.0.0.1') }} \
      --advertise-address={{ ansible_default_ipv4.address }} \
      --flannel-backend=vxlan \
      {% if k3s_disable_traefik | default(false) %}--disable traefik{% endif %} \
      --write-kubeconfig-mode=644" \
    sh /tmp/k3s-install.sh
  args:
    creates: /usr/local/bin/k3s
  when: not k3s_installed.stat.exists

- name: Wait for K3s to be ready
  wait_for:
    path: /etc/rancher/k3s/k3s.yaml
    timeout: 300

- name: Ensure K3s service is running
  systemd:
    name: k3s
    state: started
    enabled: yes

- name: Wait for K3s node to be ready
  shell: kubectl get nodes | grep -w "Ready"
  register: k3s_ready
  retries: 30
  delay: 10
  until: k3s_ready.rc == 0
  changed_when: false

- name: Create kubectl symlink for convenience
  file:
    src: /usr/local/bin/k3s
    dest: /usr/local/bin/kubectl
    state: link

- name: Create kubeconfig directory for root
  file:
    path: /root/.kube
    state: directory
    mode: '0700'

- name: Copy kubeconfig to root user
  copy:
    src: /etc/rancher/k3s/k3s.yaml
    dest: /root/.kube/config
    remote_src: yes
    mode: '0600'

- name: Set KUBECONFIG in root's bashrc
  lineinfile:
    path: /root/.bashrc
    line: "export KUBECONFIG=/root/.kube/config"
    state: present
    create: yes

- name: Enable kubectl bash completion
  lineinfile:
    path: /root/.bashrc
    line: "source <(kubectl completion bash)"
    state: present
    create: yes

- name: Add kubectl alias to bashrc
  lineinfile:
    path: /root/.bashrc
    line: "alias k=kubectl"
    state: present
    create: yes

- name: Add kubectl completion for k alias
  lineinfile:
    path: /root/.bashrc
    line: "complete -o default -F __start_kubectl k"
    state: present
    create: yes

- name: Verify kubectl is accessible
  shell: kubectl version --client --short
  register: kubectl_version
  changed_when: false
  failed_when: false

- name: Display kubectl version
  debug:
    msg: "kubectl installed: {{ kubectl_version.stdout }}"
  when: kubectl_version.rc == 0

- name: Get K3s node status
  shell: kubectl get nodes -o wide
  register: k3s_nodes
  changed_when: false

- name: Display K3s node status
  debug:
    var: k3s_nodes.stdout_lines

- name: Check Traefik ingress controller status (if enabled)
  shell: kubectl get pods -n kube-system -l app.kubernetes.io/name=traefik -o wide
  register: traefik_status
  changed_when: false
  failed_when: false
  when: not (k3s_disable_traefik | default(false))

- name: Display Traefik status
  debug:
    var: traefik_status.stdout_lines
  when: not (k3s_disable_traefik | default(false))

- name: Create nginx-ingress namespace (if Traefik is disabled)
  shell: kubectl create namespace ingress-nginx --dry-run=client -o yaml | kubectl apply -f -
  when: k3s_disable_traefik | default(false)
  changed_when: false

- name: Install nginx-ingress controller (if Traefik is disabled)
  shell: |
    kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.9.4/deploy/static/provider/cloud/deploy.yaml
  when: k3s_disable_traefik | default(false)
  changed_when: false

- name: Wait for nginx-ingress to be ready (if installed)
  shell: kubectl wait --namespace ingress-nginx --for=condition=ready pod --selector=app.kubernetes.io/component=controller --timeout=300s
  when: k3s_disable_traefik | default(false)
  changed_when: false

- name: Get ingress controller LoadBalancer IP/Port
  shell: |
    {% if k3s_disable_traefik | default(false) %}
    kubectl get svc -n ingress-nginx ingress-nginx-controller
    {% else %}
    kubectl get svc -n kube-system traefik
    {% endif %}
  register: ingress_svc
  changed_when: false

- name: Display ingress service information
  debug:
    msg:
      - "Ingress Controller Service:"
      - "{{ ingress_svc.stdout_lines }}"
      - ""
      - "Your applications will be accessible through this ingress on ports 80/443"

- name: Display next steps
  debug:
    msg:
      - "==================================================================="
      - "✅ K3s installation complete!"
      - "==================================================================="
      - ""
      - "kubectl is ready to use:"
      - "  kubectl get nodes"
      - "  k get pods -A"
      - ""
      - "Test ingress (from ansible/ directory):"
      - "  kubectl apply -f test-k8s-deployment.yaml"
      - "  curl -H 'Host: test.{{ ansible_host }}.nip.io' http://{{ ansible_host }}"
      - ""
      - "Remote access (SSH tunnel):"
      - "  ssh -L 6443:127.0.0.1:6443 root@{{ ansible_host }}"
      - "  scp root@{{ ansible_host }}:/etc/rancher/k3s/k3s.yaml ~/.kube/config"
      - ""
      - "Security:"
      - "  ✓ K3s API: 127.0.0.1 only (port 6443 blocked externally)"
      - "  ✓ Exposed: SSH (22), HTTP (80), HTTPS (443)"
      - "==================================================================="

